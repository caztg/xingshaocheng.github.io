<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>StrictMode 详解 - 专注安卓性能优化以及最佳实践的</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	
	<link rel="shortcut icon" href="/images/favicon.ico" />
	<!-- 
	<link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.cerulean.min.css" />
	 -->
	<link rel="stylesheet" type="text/css" media="screen" href="/assets/css/toc.css">
	<link rel="stylesheet" href="http://cdn.bootcss.com/twitter-bootstrap/3.0.3/css/bootstrap.min.css">
	
	<link rel="stylesheet" href="/assets/css/syntax.css" />
	<link rel="stylesheet" href="/assets/css/black.css" />
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="/assets/js/jquery.toc.js"></script>
</head>
<body>

	<!-- header -->
	<div class="container">
		<div id="header">
			<div class="logo ">
				<img alt="" src="/images/logo.png">
			</div>
			<div class="title">
				<h1>Android-Performance.com</h1>
				<h2>一个只关注安卓性能优化以及最佳实践的Blog</h2>
			</div>
			<div class="nav">
				<ul>
					
					<li>
						<a href="/" class="">主页</a></li>
					<li>
						<a href="/archive.html" class="">归档</a>
					</li>
				</ul>
			</div>
			 <div class="clearfix"></div>
		</div>
		
		<div class="clearfix">
			<div class="raw">
	 <div class="col-md-8 post">
		<h2>StrictMode 详解 </h2>
		<div class="meta">发表于 2014-04-24 23:44:45</div>
	 	<div id="main_content">
		 <p>StrictMode类是Android 2.3 （API 9）引入的一个工具类，可以用来帮助开发者发现代码中的一些不规范的问题。比如，如果你在UI线程中进行了网络或者磁盘操作，StrictMode就会通过Log（logcat ）或者对话框的方式把信息提示给你，因为让你的UI线程处理这里操作会被认为是不规范的做法，可能会让你的应用变得比较卡顿。</p>

<p>官网文档：
<a href="http://developer.android.com/reference/android/os/StrictMode.html">http://developer.android.com/reference/android/os/StrictMode.html</a></p>

<!--more-->

<h1>如何启用 StrictMode</h1>

<p>我们通常在 Activity 或者自定义的Application类中启动 StrictMode，代码如下：</p>

<div class="highlight"><pre><code class="java"> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">DEVELOPER_MODE</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">StrictMode</span><span class="o">.</span><span class="na">setThreadPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">StrictMode</span><span class="o">.</span><span class="na">ThreadPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">detectDiskReads</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">detectDiskWrites</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">detectNetwork</span><span class="o">()</span>   <span class="c1">// or .detectAll() for all detectable problems</span>
                 <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">build</span><span class="o">());</span>
         <span class="n">StrictMode</span><span class="o">.</span><span class="na">setVmPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">StrictMode</span><span class="o">.</span><span class="na">VmPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">detectLeakedSqlLiteObjects</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">detectLeakedClosableObjects</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">penaltyDeath</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">build</span><span class="o">());</span>
     <span class="o">}</span>
     <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
 <span class="o">}</span>
</code></pre></div>

<p><strong>注意：</strong>我们只需要在app的开发版本下使用 StrictMode，线上版本避免使用 StrictMode，随意需要通过 诸如 DEVELOPER_MODE 这样的配置变量来进行控制。</p>

<p>下面我们举几个例子来说明 StrictMode 是如何发挥作用的。</p>

<p>代码1：</p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivitySimple</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="n">StrictMode</span><span class="o">.</span><span class="na">setThreadPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">ThreadPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">detectAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">penaltyDialog</span><span class="o">()</span> <span class="c1">//弹出违规提示对话框</span>
                <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span> <span class="c1">//在Logcat 中打印违规异常信息</span>
                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        
        <span class="k">this</span><span class="o">.</span><span class="na">testNetwork</span><span class="o">();</span>
    <span class="o">}</span>

    
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">testNetwork</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">&quot;http://www.baidu.com&quot;</span><span class="o">);</span>
            <span class="n">HttpURLConnection</span> <span class="n">conn</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
            <span class="n">conn</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
            <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span>
                    <span class="n">conn</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
            <span class="n">String</span> <span class="n">lines</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">lines</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">lines</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>在这里例子中，我们在主线程（UI线程）中执行了网络请求，ThreadPolicy 策略中的 <code>detectAll()</code>方法 包含而来对这类违规操作的检查，同时我们通过 <code>penaltyDialog()</code> 和 <code>penaltyLog()</code> 两个方法将违规信息提示给开发者。</p>

<p>在运行这段代码是，我们会看到下图中的对话框提示：</p>

<p><img src="/images/android-strict-mode/dialog.png" /></p>

<p>在LogCat 中我们会看到这样的日志信息：
<pre>
... D/StrictMode(26365): <strong>StrictMode policy violation; ~duration=58 ms: android.os.StrictMode$StrictModeNetworkViolation: policy=63 violation=4</strong>
... D/StrictMode(26365):    at android.os.StrictMode$AndroidBlockGuardPolicy.onNetwork(StrictMode.java:1134)
... D/StrictMode(26365):    at libcore.io.BlockGuardOs.recvfrom(BlockGuardOs.java:163)
... D/StrictMode(26365):    at libcore.io.IoBridge.recvfrom(IoBridge.java:557)
... D/StrictMode(26365):    at java.net.PlainSocketImpl.read(PlainSocketImpl.java:490)
... D/StrictMode(26365):    at java.net.PlainSocketImpl.access$000(PlainSocketImpl.java:46)
...
（后面的部分省略）
</pre></p>

<h1>StrictMode 详解</h1>

<p>StrictMode 通过策略方式来让你自定义需要检查哪方面的问题。
主要有两中策略，一个时线程方策略（<a href="http://developer.android.com/reference/android/os/StrictMode.ThreadPolicy.html">ThreadPolicy</a>），一个是VM方面的策略（<a href="http://developer.android.com/reference/android/os/StrictMode.VmPolicy.html">VmPolicy</a>）。</p>

<ul>
<li><p>ThreadPolicy 主要用于发现在UI线程中是否有读写磁盘的操作，是否有网络操作，以及检查UI线程中调用的自定义代码是否执行得比较慢。</p></li>
<li><p>VmPolicy，主要用于发现内存问题，比如 Activity内存泄露， SQL 对象内存泄露， 资源未释放，能够限定某个类的最大对象数。</p></li>
</ul>

<h2>ThreadPolicy 详解</h2>

<p><a href="http://developer.android.com/reference/android/os/StrictMode.ThreadPolicy.Builder.html">StrictMode.ThreadPolicy.Builder</a> 主要方法如下：</p>

<ul>
<li><p>detectNetwork() 用于检查UI线程中是否有网络请求操作，上面的代码的就是网络请求违规的问题。</p></li>
<li><p>detectDiskReads() 和 detectDiskReads() 是磁盘读写检查，触发时会打印出如下日志（以 detectDiskReads() 为例）：
<pre>
... D/StrictMode(27429): StrictMode policy violation; ~duration=33 ms: android.os.StrictMode$StrictModeDiskReadViolation: policy=31 violation=2
... D/StrictMode(27429):    at android.os.StrictMode$AndroidBlockGuardPolicy.onReadFromDisk(StrictMode.java:1118)
... D/StrictMode(27429):    at libcore.io.BlockGuardOs.open(BlockGuardOs.java:106)
... D/StrictMode(27429):    at java.io.File.createNewFile(File.java:941)
... D/StrictMode(27429):    at com.ap.teststrictmode.ActivityTestDisk.testWriteDisk(ActivityTestDisk.java:51)
... D/StrictMode(27429):    at com.ap.teststrictmode.ActivityTestDisk.onCreate(ActivityTestDisk.java:40)
... D/StrictMode(27429):    at android.app.Activity.performCreate(Activity.java:5122)
... D/StrictMode(27429):    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1081)
... D/StrictMode(27429):    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2270)
...
（后面的部分省略）
</pre></p></li>
<li><p>detectCustomSlowCalls() 主要用于帮助开发者发现UI线程调用的那些方法执行得比较慢，要和 <code>StrictMode.noteSlowCall</code> 配合使用，<code>StrictMode.noteSlowCall</code> 只有通过 <code>StrictMode.noteSlowCall</code>用来标记“可能会”执行比较慢的方法，只有标记过的方法才能被检测到，日志中会记录方法的执行时间（比如 ~duration=2019 ms）。看下面的例子：
<br/>代码2：
<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivityTestDetectCustomSlowCalls</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span></p>

<p><span class="kd">private</span> <span class="n">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span></p>

<p><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span></p>

<p><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity<em>main</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">textView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">text</em>view</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;In ActivityTestDetectCustomSlowCalls&quot;</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(!</span> <span class="n">isStrictMode</span><span class="o">){</span>
        <span class="n">StrictMode</span><span class="o">.</span><span class="na">setThreadPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">ThreadPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">detectCustomSlowCalls</span><span class="o">()</span>
                <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span>
                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">slowCall<em>1</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">slowCall</em>2</span><span class="o">();</span>
<span class="o">}</span></p>

<p><span class="cm">/*<em></span>
<span class="cm">    * 没有标记的方法</span>
<span class="cm">    */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">slowCall_1</span><span class="o">(){</span>
    <span class="c1">//用来标记潜在执行比较慢的方法</span>
    <span class="n">SystemClock</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span> <span class="o"></em></span> <span class="mi">2</span><span class="o">);</span>
<span class="o">}</span></p>

<p><span class="cm">/<strong></span>
<span class="cm">    * 标记过的方法</span>
<span class="cm">    <em>/</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">slowCall_2</span><span class="o">(){</span>
    <span class="c1">//用来标记潜在执行比较慢的方法</span>
    <span class="n">StrictMode</span><span class="o">.</span><span class="na">noteSlowCall</span><span class="o">(</span><span class="s">&quot;slowCall 2&quot;</span><span class="o">);</span>
    <span class="n">SystemClock</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span> <span class="o"></em></span> <span class="mi">2</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<br/>在logcat 中我们只能看到和方法 <code>slowCall_2()</code>（因为通过<code>StrictMode.noteSlowCall()</code>标记过）相关的日志：<br/><pre>
...: D/StrictMode(1349): StrictMode policy violation; **~duration=2019 ms</strong>: android.os.StrictMode$StrictModeCustomViolation: policy=24 violation=8 msg=slowCall 2
...: D/StrictMode(1349):    at android.os.StrictMode$AndroidBlockGuardPolicy.onCustomSlowCall(StrictMode.java:1105)
...: D/StrictMode(1349):    at android.os.StrictMode.noteSlowCall(StrictMode.java:1903)
...: D/StrictMode(1349):    at com.ap.teststrictmode.ActivityTestDetectCustomSlowCalls.slowCall_2(ActivityTestDetectCustomSlowCalls.java:52)
...: D/StrictMode(1349):    at com.ap.teststrictmode.ActivityTestDetectCustomSlowCalls.onCreate(ActivityTestDetectCustomSlowCalls.java:35)
...: D/StrictMode(1349):    at android.app.Activity.performCreate(Activity.java:5122)
...: D/StrictMode(1349):    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1081)
...: D/StrictMode(1349):    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2270)
...: D/StrictMode(1349):    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2358)
...: D/StrictMode(1349):    at android.app.ActivityThread.access$600(ActivityThread.java:156)
...: D/StrictMode(1349):    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1340)
...: D/StrictMode(1349):    at android.os.Handler.dispatchMessage(Handler.java:99)
...: D/StrictMode(1349):    at android.os.Looper.loop(Looper.java:153)
...
（后面的部分省略）
</pre>
<br/>当然你也可以在其他线程中使用 detectCustomSlowCalls()，但是没有什么实际意义，也看不到方法执行时间，比如：</p></li>
</ul>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivityTestDetectCustomSlowCalls</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    
    <span class="kd">private</span> <span class="n">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">textView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">text_view</span><span class="o">);</span>
        
        <span class="k">this</span><span class="o">.</span><span class="na">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;In ActivityTestDetectCustomSlowCalls&quot;</span><span class="o">);</span>
        
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(){</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">StrictMode</span><span class="o">.</span><span class="na">setThreadPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">ThreadPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">detectCustomSlowCalls</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">());</span>
                
                <span class="k">this</span><span class="o">.</span><span class="na">slowCallInCustomThread</span><span class="o">();</span>
            <span class="o">};</span>
            
            <span class="kd">private</span> <span class="kt">void</span> <span class="nf">slowCallInCustomThread</span><span class="o">(){</span>
                <span class="c1">//用来标记潜在执行比较慢的方法</span>
                <span class="n">StrictMode</span><span class="o">.</span><span class="na">noteSlowCall</span><span class="o">(</span><span class="s">&quot;slowCallInCustomThread&quot;</span><span class="o">);</span>
                <span class="n">SystemClock</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">2</span><span class="o">);</span>
            <span class="o">}</span>            
        <span class="o">}.</span><span class="na">start</span><span class="o">();;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>日志输出如下：</p>

<pre>
...: D/StrictMode(2418): StrictMode policy violation: android.os.StrictMode$StrictModeCustomViolation: policy=24 violation=8 msg=slowCallInCustomThread
...: D/StrictMode(2418):    at android.os.StrictMode$AndroidBlockGuardPolicy.onCustomSlowCall(StrictMode.java:1105)
...: D/StrictMode(2418):    at android.os.StrictMode.noteSlowCall(StrictMode.java:1903)
...: D/StrictMode(2418):    at com.ap.teststrictmode.ActivityTestDetectCustomSlowCalls$1.slowCallInCustomThread(ActivityTestDetectCustomSlowCalls.java:35)
...: D/StrictMode(2418):    at com.ap.teststrictmode.ActivityTestDetectCustomSlowCalls$1.run(ActivityTestDetectCustomSlowCalls.java:30)
...
（后面的部分省略）
</pre>

<ul>
<li><p>penaltyDeath()，当触发违规条件时，直接Crash掉当前应用程序。</p></li>
<li><p>penaltyDeathOnNetwork()，当触发网络违规时，Crash掉当前应用程序。</p></li>
<li><p>penaltyDialog()，触发违规时，显示对违规信息对话框。</p></li>
<li><p>penaltyFlashScreen()，会造成屏幕闪烁，不过一般的设备可能没有这个功能。</p></li>
<li><p>penaltyDropBox()，将违规信息记录到 dropbox 系统日志目录中（/data/system/dropbox），你可以通过如下命令进行插件：
<pre>
<em>adb shell dumpsys dropbox data<em>app</em>strictmode  --print</em>
</pre>
会得到如下的信息：
<pre>
2014-05-04 14:56:32 data<em>app</em>strictmode (text, 2627 bytes)
Process: com.ap.teststrictmode
Flags: 0x40a8be46
Package: com.ap.teststrictmode v1 (1.0)
Build: Xiaomi/pisces/pisces:4.2.1/JOP40D/JXCCNBA13.0:user/release-keys
System-App: false
Uptime-Millis: 66679049
Loop-Violation-Number: 10
Duration-Millis: 24
android.os.StrictMode$StrictModeNetworkViolation: policy=191 violation=4
    at android.os.StrictMode$AndroidBlockGuardPolicy.onNetwork(StrictMode.java:1136)
    at libcore.io.BlockGuardOs.recvfrom(BlockGuardOs.java:163)
    at libcore.io.IoBridge.recvfrom(IoBridge.java:513)
    at java.net.PlainSocketImpl.read(PlainSocketImpl.java:488)
    at java.net.PlainSocketImpl.access$000(PlainSocketImpl.java:46)
    at java.net.PlainSocketImpl$PlainSocketInputStream.read(PlainSocketImpl.java:240)
    at java.io.InputStream.read(InputStream.java:163)
    at java.io.BufferedInputStream.fillbuf(BufferedInputStream.java:142)
    at java.io.BufferedInputStream.read(BufferedInputStream.java:227)
    at libcore.io.Streams.readAsciiLine(Streams.java:201)
    at libcore.net.http.ChunkedInputStream.readChunkSize(ChunkedInputStream.java:77)
    at libcore.net.http.ChunkedInputStream.read(ChunkedInputStream.java:68)
    at java.io.InputStream.read(InputStream.java:163)
    at java.util.zip.InflaterInputStream.fill(InflaterInputStream.java:200)
    at java.util.zip.InflaterInputStream.read(InflaterInputStream.java:154)
    at java.util.zip.GZIPInputStream.read(GZIPInputStream.java:167)
...
</pre></p></li>
<li><p>permitCustomSlowCalls()、permitDiskReads ()、permitDiskWrites()、permitNetwork： 如果你想关闭某一项检测，可以使用对应的permit*方法。</p></li>
</ul>

<h2>VMPolicy 详解</h2>

<ul>
<li>detectActivityLeaks() 用户检查 Activity 的内存泄露情况，比如下面的代码：</li>
</ul>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivityTestActivityLeaks</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(!</span> <span class="n">isStrictMode</span><span class="o">){</span>
            
            <span class="n">StrictMode</span><span class="o">.</span><span class="na">setVmPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">VmPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">detectActivityLeaks</span><span class="o">()</span>
            <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">()</span> <span class="o">{</span>
              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    
                  <span class="n">SystemClock</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span>
              <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>我们反复旋转屏幕就会输出如下信息（重点在 instances=4; limit=1 这一行）：
<pre>
...: E/StrictMode(4784): class com.ap.teststrictmode.ActivityTestActivityLeaks; instances=4; limit=1
...: E/StrictMode(4784): android.os.StrictMode$InstanceCountViolation: class com.ap.teststrictmode.ActivityTestActivityLeaks; instances=4; limit=1
...: E/StrictMode(4784):    at android.os.StrictMode.setClassInstanceLimit(StrictMode.java:1)
</pre></p>

<p>这时因为，我们在Activity中创建了一个Thread匿名内部类，而匿名内部类隐式持有外部类的引用。而每次旋转屏幕是，Android会新创建一个Activity，而原来的Activity实例又被我们启动的匿名内部类线程持有，所以不会释放，从日志上看，当先系统中该Activty有4个实例，而限制是只能创建1各实例。我们不断翻转屏幕，instances 的个数还会持续增加。</p>

<ul>
<li>detectLeakedClosableObjects() 和 detectLeakedSqlLiteObjects()，资源没有正确关闭时回触发，比如下面的代码：</li>
</ul>

<div class="highlight"><pre><code class="java"> 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivityTestDetectLeakedClosableObjects</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        
        <span class="k">if</span><span class="o">(!</span> <span class="n">isStrictMode</span><span class="o">){</span>
            <span class="n">StrictMode</span><span class="o">.</span><span class="na">setVmPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">VmPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">detectLeakedClosableObjects</span><span class="o">()</span>
            <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="n">File</span> <span class="n">newxmlfile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">(),</span> <span class="s">&quot;aaa.txt&quot;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">newxmlfile</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
            <span class="n">FileWriter</span> <span class="n">fw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileWriter</span><span class="o">(</span><span class="n">newxmlfile</span><span class="o">);</span>
            <span class="n">fw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">&quot;aaaaaaaaaaa&quot;</span><span class="o">);</span>
            <span class="c1">//fw.close(); 我们在这里故意没有关闭 fw</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>会产生如下异常信息：</p>

<pre>
... E/StrictMode(22056): A resource was acquired at attached stack trace but never released. See java.io.Closeable for information on avoiding resource leaks.
... E/StrictMode(22056): java.lang.Throwable: Explicit termination method 'close' not called
... E/StrictMode(22056):    at dalvik.system.CloseGuard.open(CloseGuard.java:184)
... E/StrictMode(22056):    at java.io.FileOutputStream.<init>(FileOutputStream.java:90)
... E/StrictMode(22056):    at java.io.FileOutputStream.<init>(FileOutputStream.java:73)
... E/StrictMode(22056):    at java.io.FileWriter.<init>(FileWriter.java:42)
... E/StrictMode(22056):    at com.ap.teststrictmode.MainActivityTestDetectLeakedClosableObjects.onCreate(MainActivityTestDetectLeakedClosableObjects.java:44)
... E/StrictMode(22056):    at android.app.Activity.performCreate(Activity.java:5122)
... E/StrictMode(22056):    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1081)
... E/StrictMode(22056):    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2270)
... E/StrictMode(22056):    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2358)
... E/StrictMode(22056):    at android.app.ActivityThread.handleRelaunchActivity(ActivityThread.java:3865)
（后面的省略）
</pre>

<p>detectLeakedSqlLiteObjects() 和 detectLeakedClosableObjects()的用法类似，只不过是用来检查  SQLiteCursor 或者 其他 SQLite 对象是否被正确关闭。</p>

<ul>
<li>detectLeakedRegistrationObjects() 用来检查 BroadcastReceiver 或者 ServiceConnection 注册类对象是否被正确释放，看下面的代码</li>
</ul>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivityTestLeakedRegistrationObjects</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">MyReceiver</span> <span class="n">receiver</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">textView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">text_view</span><span class="o">);</span>
        
        <span class="k">this</span><span class="o">.</span><span class="na">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;In ActivityTestLeakedRegistrationObjects&quot;</span><span class="o">);</span>

        
        <span class="k">if</span><span class="o">(!</span> <span class="n">isStrictMode</span><span class="o">){</span>
            <span class="n">StrictMode</span><span class="o">.</span><span class="na">setVmPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">VmPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">detectLeakedRegistrationObjects</span><span class="o">()</span>
            <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="k">this</span><span class="o">.</span><span class="na">receiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyReceiver</span><span class="o">();</span>  
        <span class="n">IntentFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">();</span>  
        <span class="n">filter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="s">&quot;android.intent.action.MY_BROADCAST&quot;</span><span class="o">);</span> 
        <span class="n">registerReceiver</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">receiver</span><span class="o">,</span> <span class="n">filter</span><span class="o">);</span> 
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>输入信息如下：</p>

<pre>
...: E/ActivityThread(24442): Activity com.ap.teststrictmode.ActivityTestLeakedRegistrationObjects has leaked IntentReceiver com.ap.teststrictmode.MyReceiver@41f1f128 that was originally registered here. Are you missing a call to unregisterReceiver()?
...: E/ActivityThread(24442): android.app.IntentReceiverLeaked: Activity com.ap.teststrictmode.ActivityTestLeakedRegistrationObjects has leaked IntentReceiver com.ap.teststrictmode.MyReceiver@41f1f128 that was originally registered here. Are you missing a call to unregisterReceiver()?
...: E/ActivityThread(24442):   at android.app.LoadedApk$ReceiverDispatcher.<init>(LoadedApk.java:825)
...: E/ActivityThread(24442):   at android.app.LoadedApk.getReceiverDispatcher(LoadedApk.java:596)
...: E/ActivityThread(24442):   at android.app.ContextImpl.registerReceiverInternal(ContextImpl.java:1388)
...: E/ActivityThread(24442):   at android.app.ContextImpl.registerReceiver(ContextImpl.java:1368)
...
</pre>

<p>正确做法应该是在 onDestroy() 方法中将 receiver 释放掉：</p>

<div class="highlight"><pre><code class="java"> <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">unregisterReceiver</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">receiver</span><span class="o">);</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div>

<ul>
<li>setClassInstanceLimit()，设置某个类的同时处于内存中的实例上限，可以协助检查内存泄露。比如下面的代码：</li>
</ul>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivityTestObjectLimit</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyClass</span><span class="o">{}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span> <span class="n">classList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ActivityTestObjectLimit</span><span class="o">.</span><span class="na">MyClass</span><span class="o">&gt;();</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(!</span> <span class="n">isStrictMode</span><span class="o">){</span>
            <span class="n">StrictMode</span><span class="o">.</span><span class="na">setVmPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">VmPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">setClassInstanceLimit</span><span class="o">(</span><span class="n">MyClass</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
            <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="n">isStrictMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="n">classList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClass</span><span class="o">());</span>
        <span class="n">classList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClass</span><span class="o">());</span>
        <span class="n">classList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClass</span><span class="o">());</span>
        <span class="n">classList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClass</span><span class="o">());</span>
        <span class="n">classList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClass</span><span class="o">());</span>
        <span class="n">classList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClass</span><span class="o">());</span>
        <span class="n">classList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClass</span><span class="o">());</span>
        <span class="n">classList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClass</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>日志信息如下：
<pre>
...: E/StrictMode(27681): class com.ap.teststrictmode.ActivityTestObjectLimit$MyClass; instances=72; limit=2
...: E/StrictMode(27681): android.os.StrictMode$InstanceCountViolation: class com.ap.teststrictmode.ActivityTestObjectLimit$MyClass; instances=8; limit=2
...: E/StrictMode(27681):   at android.os.StrictMode.setClassInstanceLimit(StrictMode.java:1)
</pre></p>

<p>注意：上面的异常一般都在GC之后抛出，如果测试的时候没有现象，可以多翻转几次屏幕，或者通过DDMS工具手动触发一下。</p>

	 	</div>
		<div class="ds-thread"></div>
	 </div>
	 <div class="col-md-4">
	 	<div id="sideblock_toc" style="display: none;"></div>
	 	<div class="sideblock">
	 		<h3>
	 			最新文章
	 		</h3>
	 		<ul>
	 			
	 				<li><a href="/android/2014/04/24/android-strict-mode.html">StrictMode 详解</a></li>
	 			
	 				<li><a href="/android/2014/03/12/android-anr.html">【转】使程序保持响应（中英对照）</a></li>
	 			
	 				<li><a href="/android/2014/02/17/android-manage-memory.html">Android中的内存管理</a></li>
	 			
	 				<li><a href="/android/2014/02/10/android-sparsearray-vs-hashmap.html">SparseArray替代HashMap来提高性能</a></li>
	 			
	 				<li><a href="/android/2014/01/29/android-sth-about-png-optimization.html">Android中关于PNG优化的那点事</a></li>
	 			
	 		</ul>
	 	</div>
	 	<div class="sideblock">
	 		<h3>
	 			相关文章
	 		</h3>
	 		<ul>
	 			
	 				<li><a href="/android/2014/03/12/android-anr.html">【转】使程序保持响应（中英对照）</a></li>
	 			
	 				<li><a href="/android/2014/02/17/android-manage-memory.html">Android中的内存管理</a></li>
	 			
	 				<li><a href="/android/2014/02/10/android-sparsearray-vs-hashmap.html">SparseArray替代HashMap来提高性能</a></li>
	 			
	 				<li><a href="/android/2014/01/29/android-sth-about-png-optimization.html">Android中关于PNG优化的那点事</a></li>
	 			
	 				<li><a href="/android/2014/01/26/android-perf-tips.html">Android 性能小贴士</a></li>
	 			
	 		</ul>
	 	</div>
	 </div>
</div>
<script type="text/javascript">$('#main_content').toc({
	containerDomId : 'sideblock_toc'
});</script>


<!-- Duoshuo Comment BEGIN -->
	
<script type="text/javascript">
var duoshuoQuery = {short_name:"androidperformance"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->
		</div>
		
		<div id="footer">
				© 2013–2014			
		</div>
	</div>
	<div style="display: none;" >
	<script type="text/javascript">
	var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
	document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe4e170c12e7c50f61b4e5b193cbd5ec8' type='text/javascript'%3E%3C/script%3E"));
	</script>
	</div>
</body>
</html>
